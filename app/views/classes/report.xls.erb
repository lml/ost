<%# Copyright 2011-2012 Rice University. Licensed under the Affero General Public 
    License version 3 or later.  See the COPYRIGHT file for details. %>

<% present_user_is_researcher = present_user.is_researcher? %>

<%  
  ae_info = { }
  @klass.learning_plan.topics.each do |topic|
    topic.topic_exercises.each do |te|
      te.assignment_exercises.each do |ae|
        ae_info[ae] = { :number       => ae.number,
                        :quadbase_id  => ae.topic_exercise.exercise.quadbase_id,
                        :concept      => ae.topic_exercise.concept.try(:name),
                        :tag_list     => ae.tag_list,
                        :fb_required  => false}
        if ae.student_exercises.any?
          ae_info[ae][:fb_required] = ae.student_exercises.first.feedback_required_for_credit?
        end
      end
    end
  end

  response_time_query = ResponseTime.where{ (note =~ "READY%") & (page == "feedback") }
%>

<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:x="urn:schemas-microsoft-com:office:excel"
  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:html="http://www.w3.org/TR/REC-html40">
  <Worksheet ss:Name="Data">
    <Table>
      <Row>
        <%= render "report_heading_cell", data: "Name/ID",       comment: "Student name, Educator-facing ID, or Research ID" %>
        <%= render "report_heading_cell", data: "RegStatus",     comment: "Student Registration Status" %>
        <%= render "report_heading_cell", data: "Section",       comment: "Student Class Section name" %>
        <%= render "report_heading_cell", data: "Section",       comment: "Student Cohort name" %>
        <%= render "report_heading_cell", data: "AssgnName",     comment: "Assignment name" %>
        <%= render "report_heading_cell", data: "AssgnNum",      comment: "Assignment order number within Learning Plan (including tests)" %>
        <%= render "report_heading_cell", data: "ExNum",         comment: "Exercise order number (within Assignment)" %>
        <%= render "report_heading_cell", data: "ExQbId",        comment: "Exercise Quadbase ID" %>
        <%= render "report_heading_cell", data: "ExConcept",     comment: "Exercise Concept description" %>
        <%= render "report_heading_cell", data: "ExLabels",      comment: "Exercise Labels" %>
        <%= render "report_heading_cell", data: "AssgnCws",      comment: "Assignment Coworkers (including Student), sorted, comma-separated" %>
        <%= render "report_heading_cell", data: "FreeResp?",     comment: "Student locked-in a Free Response?" %>
        <%= render "report_heading_cell", data: "FreeRespTime",  comment: "Time at which Free Response was locked-in" %>
        <%= render "report_heading_cell", data: "FreeResp",      comment: "Free Response" %>
        <%= render "report_heading_cell", data: "SelAns?",       comment: "Student locked-in a Selected Answer?" %>
        <%= render "report_heading_cell", data: "SelAnsTime",    comment: "Time at which Selected Answer was locked-in" %>
        <%= render "report_heading_cell", data: "SelAns",        comment: "Selected Answer {0 == 'a', 1 == 'b', ...}" %>
        <%= render "report_heading_cell", data: "SelAnsConf",    comment: "Selected Answer Confidence {0 == 'Definitely Wrong, ..., 4 == 'Definitely Right'}" %>
        <%= render "report_heading_cell", data: "SelAnsCredit",  comment: "Selected Answer Credit [0..1]" %>
        <%= render "report_heading_cell", data: "FbScaling",     comment: "Feedback Scaling Factor {0,1}" %>
        <%= render "report_heading_cell", data: "OverallCredit", comment: "Overall Exercise Credit [0..1] (combines Credit and Feedback Scaling)" %>
        <%= render "report_heading_cell", data: "Comp?",         comment: "Exercise was completed?" %>
        <%= render "report_heading_cell", data: "CompOnTime?",   comment: "Exercise was completed before the due date?" %>
        <%= render "report_heading_cell", data: "Correct?",      comment: "Selected Answer was correct? {Yes, No, Partially}" %>
        <%= render "report_heading_cell", data: "FbViewReq?",    comment: "Viewing Feedback was required for Overall Credit?" %>
        <%= render "report_heading_cell", data: "FbViewed?",     comment: "Feedback was viewed (ever)?" %>
        <%= render "report_heading_cell", data: "FbViewed?",     comment: "Feedback was viewed with the Feedback Credit Window?" %>
        <%= render "report_heading_cell", data: "FbLoadCount",   comment: "Approx. number of times Feedback page was loaded by the Student" %>
      </Row>
      <% @klass.sections.each do |section| %>
        <% section_name = section.name %>
        <% section.students.visible(present_user).each do |student| %>
          <% student_full_name  = student.full_name(present_user) %>
          <% student_reg_status = student_status_string(student) %>
          <% cohort_name        = student.cohort.name %>
          <% StudentAssignment.for_student(student).sort_by{|sa| sa.assignment.assignment_plan.starts_at}.each_with_index do |sa, ii| %>
            <% assignment_num  = ii + 1 %>
            <% assignment_name = sa.assignment.assignment_plan.name %>
            <% assignment_coworkers = sa.assignment_coworkers.collect{|acw| acw.student}.uniq.concat([student]).collect{|s| s.full_name(present_user)}.sort_by{|s| s.downcase}.join(',') %>
            <% sa.student_exercises.each do |se| %>
              <% ae = se.assignment_exercise %>
      <Row>
        <Cell><Data ss:Type="String"><%= student_full_name %></Data></Cell>
        <Cell><Data ss:Type="String"><%= student_reg_status %></Data></Cell>
        <Cell><Data ss:Type="String"><%= section_name %></Data></Cell>
        <Cell><Data ss:Type="String"><%= cohort_name %></Data></Cell>
        <Cell><Data ss:Type="String"><%= assignment_name %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= assignment_num %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= ae_info[ae][:number] %></Data></Cell>
        <Cell><Data ss:Type="String"><%= ae_info[ae][:quadbase_id] %></Data></Cell>
        <Cell><Data ss:Type="String"><%= ae_info[ae][:concept] %></Data></Cell>
        <Cell><Data ss:Type="String"><%= ae_info[ae][:tag_list] %></Data></Cell>
        <Cell><Data ss:Type="String"><%= assignment_coworkers %></Data></Cell>
        <Cell><Data ss:Type="String"><%= tf_to_yn(se.free_response_submitted?) %></Data></Cell>
        <Cell><Data ss:Type="String"><%= se.free_response_submitted_at %></Data></Cell>
        <Cell><Data ss:Type="String"><%= se.free_responses.collect{|fr| fr.as_text}.join('; ') %></Data></Cell>
        <Cell><Data ss:Type="String"><%= tf_to_yn(se.selected_answer_submitted?) %></Data></Cell>
        <Cell><Data ss:Type="String"><%= se.selected_answer_submitted_at %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= se.selected_answer %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= se.free_response_confidence %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= se.automated_credit %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= se.feedback_credit_multiplier %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= se.score %></Data></Cell>
        <Cell><Data ss:Type="String"><%= tf_to_yn(se.complete?) %></Data></Cell>
        <Cell><Data ss:Type="String"><%= tf_to_yn(se.complete? && !se.was_submitted_late) %></Data></Cell>
        <Cell><Data ss:Type="String"><%= exercise_correctness_string(se) %></Data></Cell>
        <Cell><Data ss:Type="String"><%= tf_to_yn(ae_info[ae][:fb_required]) %></Data></Cell>
        <Cell><Data ss:Type="String"><%= tf_to_yn(se.feedback_has_been_viewed?) %></Data></Cell>
        <Cell><Data ss:Type="String"><%= tf_to_yn(se.feedback_has_been_viewed_for_credit?) %></Data></Cell>
        <Cell><Data ss:Type="Number"><%= response_time_query.where{ |rt| rt.response_timeable_id == se.id }.count %></Data></Cell>
      </Row>
            <% end %>
          <% end %> 
        <% end %>
      <% end %>
    </Table>
  </Worksheet>
  <Worksheet ss:Name="Info">
    <Table>
      <Row>
        <Cell><Data ss:Type="String">Organization</Data></Cell>
        <Cell><Data ss:Type="String"><%= @klass.course.organization.name %></Data></Cell>
      </Row>
      <Row>
        <Cell><Data ss:Type="String">Class</Data></Cell>
        <Cell><Data ss:Type="String"><%= @klass.name %></Data></Cell>
      </Row>
      <Row>
        <Cell><Data ss:Type="String">Dates</Data></Cell>
        <Cell><Data ss:Type="String"><%= standard_datetime(@klass.start_date) + " to " + standard_datetime(@klass.end_date)%></Data></Cell>
      </Row>
      <Row>
        <Cell><Data ss:Type="String">Instructors</Data></Cell>
        <Cell><Data ss:Type="String"><%= @klass.educators.select{|e| e.is_instructor}.collect{|e| e.user.full_name}.join(", ") %></Data></Cell>
      </Row>
    </Table>
  </Worksheet>
</Workbook>